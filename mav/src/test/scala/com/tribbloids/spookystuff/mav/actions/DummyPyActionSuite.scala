package com.tribbloids.spookystuff.mav.actions

import com.tribbloids.spookystuff.SpookyEnvFixture
import com.tribbloids.spookystuff.doc.Doc

/**
  * Created by peng on 01/09/16.
  */
class DummyPyActionSuite extends SpookyEnvFixture {

  val action = DummyPyAction()

  test("can execute on driver") {

    val doc = action.fetch(spooky)
    doc.flatMap(_.asInstanceOf[Doc].code).mkString("\n").shouldBe("3")
  }

  import com.tribbloids.spookystuff.dsl._

  test("can execute on workers") {
    val df = sql
      .createDataFrame((0 to 99)
        .map(v => Tuple1(v)))
    val ds = spooky.create(
      df
    )
    val result = ds
      .fetch(
        DummyPyAction('_1.typed[Int]) ~ 'A
      )
      .extract(S.code)
      .toJSON()
      .collect()
      .sortBy(identity)
      .mkString("\n")

    result.shouldBe(
      """
        |{"_1":0,"_c1":"2"}
        |{"_1":1,"_c1":"3"}
        |{"_1":10,"_c1":"12"}
        |{"_1":11,"_c1":"13"}
        |{"_1":12,"_c1":"14"}
        |{"_1":13,"_c1":"15"}
        |{"_1":14,"_c1":"16"}
        |{"_1":15,"_c1":"17"}
        |{"_1":16,"_c1":"18"}
        |{"_1":17,"_c1":"19"}
        |{"_1":18,"_c1":"20"}
        |{"_1":19,"_c1":"21"}
        |{"_1":2,"_c1":"4"}
        |{"_1":20,"_c1":"22"}
        |{"_1":21,"_c1":"23"}
        |{"_1":22,"_c1":"24"}
        |{"_1":23,"_c1":"25"}
        |{"_1":24,"_c1":"26"}
        |{"_1":25,"_c1":"27"}
        |{"_1":26,"_c1":"28"}
        |{"_1":27,"_c1":"29"}
        |{"_1":28,"_c1":"30"}
        |{"_1":29,"_c1":"31"}
        |{"_1":3,"_c1":"5"}
        |{"_1":30,"_c1":"32"}
        |{"_1":31,"_c1":"33"}
        |{"_1":32,"_c1":"34"}
        |{"_1":33,"_c1":"35"}
        |{"_1":34,"_c1":"36"}
        |{"_1":35,"_c1":"37"}
        |{"_1":36,"_c1":"38"}
        |{"_1":37,"_c1":"39"}
        |{"_1":38,"_c1":"40"}
        |{"_1":39,"_c1":"41"}
        |{"_1":4,"_c1":"6"}
        |{"_1":40,"_c1":"42"}
        |{"_1":41,"_c1":"43"}
        |{"_1":42,"_c1":"44"}
        |{"_1":43,"_c1":"45"}
        |{"_1":44,"_c1":"46"}
        |{"_1":45,"_c1":"47"}
        |{"_1":46,"_c1":"48"}
        |{"_1":47,"_c1":"49"}
        |{"_1":48,"_c1":"50"}
        |{"_1":49,"_c1":"51"}
        |{"_1":5,"_c1":"7"}
        |{"_1":50,"_c1":"52"}
        |{"_1":51,"_c1":"53"}
        |{"_1":52,"_c1":"54"}
        |{"_1":53,"_c1":"55"}
        |{"_1":54,"_c1":"56"}
        |{"_1":55,"_c1":"57"}
        |{"_1":56,"_c1":"58"}
        |{"_1":57,"_c1":"59"}
        |{"_1":58,"_c1":"60"}
        |{"_1":59,"_c1":"61"}
        |{"_1":6,"_c1":"8"}
        |{"_1":60,"_c1":"62"}
        |{"_1":61,"_c1":"63"}
        |{"_1":62,"_c1":"64"}
        |{"_1":63,"_c1":"65"}
        |{"_1":64,"_c1":"66"}
        |{"_1":65,"_c1":"67"}
        |{"_1":66,"_c1":"68"}
        |{"_1":67,"_c1":"69"}
        |{"_1":68,"_c1":"70"}
        |{"_1":69,"_c1":"71"}
        |{"_1":7,"_c1":"9"}
        |{"_1":70,"_c1":"72"}
        |{"_1":71,"_c1":"73"}
        |{"_1":72,"_c1":"74"}
        |{"_1":73,"_c1":"75"}
        |{"_1":74,"_c1":"76"}
        |{"_1":75,"_c1":"77"}
        |{"_1":76,"_c1":"78"}
        |{"_1":77,"_c1":"79"}
        |{"_1":78,"_c1":"80"}
        |{"_1":79,"_c1":"81"}
        |{"_1":8,"_c1":"10"}
        |{"_1":80,"_c1":"82"}
        |{"_1":81,"_c1":"83"}
        |{"_1":82,"_c1":"84"}
        |{"_1":83,"_c1":"85"}
        |{"_1":84,"_c1":"86"}
        |{"_1":85,"_c1":"87"}
        |{"_1":86,"_c1":"88"}
        |{"_1":87,"_c1":"89"}
        |{"_1":88,"_c1":"90"}
        |{"_1":89,"_c1":"91"}
        |{"_1":9,"_c1":"11"}
        |{"_1":90,"_c1":"92"}
        |{"_1":91,"_c1":"93"}
        |{"_1":92,"_c1":"94"}
        |{"_1":93,"_c1":"95"}
        |{"_1":94,"_c1":"96"}
        |{"_1":95,"_c1":"97"}
        |{"_1":96,"_c1":"98"}
        |{"_1":97,"_c1":"99"}
        |{"_1":98,"_c1":"100"}
        |{"_1":99,"_c1":"101"}
      """.trim.stripMargin
    )
  }
}